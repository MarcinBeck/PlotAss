<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Fabularny Asystent</title>
    <style>
        /* Minimalne style CSS */
        body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; line-height: 1.6; background-color: #f4f4f9; }
        h1 { color: #333; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { 
            padding: 12px 25px; 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 16px; 
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        #wynik-analizy, #wynik-rozdziału, #profile-json, #history-json { background-color: #e9ecef; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; color: #333; border: 1px dashed #aaa;}
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>LLM Fabularny Asystent: Zarządzanie Treścią</h1>
    
    <div class="section" id="rozdziały">
        <h2>0. Dodaj/Aktualizuj Rozdział (Wprowadzanie Surowej Treści)</h2>
        
        <label for="chapter-id">ID Rozdziału (np. CH-01):</label>
        <input type="text" id="chapter-id" value="CH-01">

        <label for="chapter-title">Tytuł Rozdziału:</label>
        <input type="text" id="chapter-title" placeholder="Wyprawa na Północ">
        
        <label for="chapter-content">Treść Rozdziału (Surowy Tekst):</label>
        <textarea id="chapter-content" rows="15" placeholder="Wpisz tu cały tekst rozdziału. System użyje go do automatycznej analizy..."></textarea>
        
        <button onclick="zapiszRozdzial()">ZAPISZ I AKTUALIZUJ TREŚĆ</button>
        <pre id="wynik-rozdziału" style="margin-top: 15px;">Status zapisu: Oczekuję na dane...</pre>
    </div>
    
    <div class="section" id="wejscie">
        <h2>1. Weryfikacja Spójności Sceny (FAZA II)</h2>
        
        <label for="postac-glowna">Postać Główna (Weryfikowana):</label>
        <select id="postac-glowna">
            <option value="TARAS_1">Taras (Introwertyk, Gaja)</option>
            <option value="PIOTR_1">Piotr (Ekstrawertyk, Ziemia)</option>
            <option value="DERYL_1">Deryl (Formalista, Kula)</option>
        </select>
        
        <label for="opis-sceny">Treść Sceny / Pytanie do Weryfikacji:</label>
        <textarea id="opis-sceny" rows="8" placeholder="Wklej tutaj opis nowej sceny lub pytanie. Np.: 'Taras widzi, że jego szef jest w opałach. Jak zareaguje?'"></textarea>
        
        <button onclick="wywolajWeryfikacje()">WERYFIKUJ SPÓJNOŚĆ (LLM)</button>
        <pre id="wynik-analizy">Oczekuję na wynik weryfikacji...</pre>
    </div>

    <div class="section" id="widok-postaci">
        <h2>3. Widok Złożony Postaci (Profil + Historia)</h2>
        
        <label for="char-select">Wybierz Postać:</label>
        <select id="char-select">
            <option value="TARAS_1">Taras</option>
            <option value="PIOTR_1">Piotr</option>
            <option value="DERYL_1">Deryl</option>
        </select>
        
        <button onclick="pobierzProfil()">POBIERZ PROFIL I HISTORIĘ</button>
        
        <div id="profile-output" style="margin-top: 20px;">
            <h3>Profil:</h3>
            <pre id="profile-json">Oczekuję na dane...</pre>
            
            <h3>Historia Zdarzeń (Weryfikacja Łuku):</h3>
            <pre id="history-json">Oczekuję na dane...</pre>
        </div>
    </div>

    <script>
        // --- ENDPOINTY LAMBDA ---
        
        // TWOJE ISTNIEJĄCE ENDPOINTY:
        const API_ENDPOINT = 'https://92vbt9pfrg.execute-api.eu-north-1.amazonaws.com/default/LLM_Verifier'; 
        const CHAPTER_MANAGER_ENDPOINT = 'https://xh1yycg8fh.execute-api.eu-north-1.amazonaws.com/default/LLM_QueryResolver'; 
        
        // NOWY ENDPOINT DLA ZŁOŻONYCH ZAPYTAŃ:
        const QUERY_RESOLVER_ENDPOINT = 'https://xh1yycg8fh.execute-api.eu-north-1.amazonaws.com/default/LLM_QueryResolver'; // <--- Wklej nowy URL tutaj!
        
        // --- FUNKCJA 0: ZAPIS I AKTUALIZACJA ROZDZIAŁU ---

        function zapiszRozdzial() {
            const chapterId = document.getElementById('chapter-id').value;
            const title = document.getElementById('chapter-title').value;
            const content = document.getElementById('chapter-content').value;
            const statusDiv = document.getElementById('wynik-rozdziału');
            
            if (!chapterId || !title || !content) {
                statusDiv.textContent = 'BŁĄD: Wszystkie pola rozdziału muszą być wypełnione!';
                return;
            }

            statusDiv.textContent = 'Trwa wysyłanie rozdziału do ChapterManager...';

            fetch(CHAPTER_MANAGER_ENDPOINT, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chapterId: chapterId,
                    title: title,
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Błąd HTTP: ${response.status}. Sprawdź logi CloudWatch i konfigurację CORS/IAM.`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    statusDiv.textContent = `BŁĄD LAMBDA: ${data.error}`;
                    statusDiv.className = 'error';
                } else {
                    const chapterData = data.data || data; 
                    
                    if (chapterData && chapterData.CHAPTER_ID) {
                        statusDiv.className = '';
                        statusDiv.textContent = `SUKCES! Rozdział ${chapterData.CHAPTER_ID} zapisany. 
Status: ${chapterData.STATUS}. 
Timestamp: ${chapterData.VERSION_TIMESTAMP}`;
                    } else {
                        statusDiv.className = 'error';
                        statusDiv.textContent = `BŁĄD STRUKTURY DANYCH: Nie znaleziono CHAPTER_ID. Pełna odpowiedź: ${JSON.stringify(data)}`;
                    }
                }
            })
            .catch(error => {
                statusDiv.className = 'error';
                statusDiv.textContent = 'BŁĄD POŁĄCZENIA: ' + error.message;
                console.error('Błąd zapisu rozdziału:', error);
            });
        }
        
        // --- FUNKCJA 1: WERYFIFIKACJA SPÓJNOŚCI (Istniejąca) ---

        function wywolajWeryfikacje() {
            // Logika pominięta dla zachowania czystości
        }
        
        // --- FUNKCJA 3: POBIERANIE ZŁOŻONEGO WIDOKU POSTACI ---

        function pobierzProfil() {
            const charId = document.getElementById('char-select').value;
            const profileOutput = document.getElementById('profile-json');
            const historyOutput = document.getElementById('history-json');
            
            profileOutput.textContent = 'Pobieranie danych...';
            historyOutput.textContent = 'Pobieranie danych...';

            // Używamy QUERY_RESOLVER_ENDPOINT z parametrem (charId)
            fetch(`${QUERY_RESOLVER_ENDPOINT}?characterId=${charId}`, {
                method: 'GET', 
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Błąd HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    profileOutput.textContent = 'BŁĄD: ' + data.error;
                    historyOutput.textContent = '';
                } else {
                    // Formatowanie JSON do wyświetlenia
                    profileOutput.textContent = JSON.stringify(data.profile, null, 2);
                    historyOutput.textContent = JSON.stringify(data.history, null, 2);
                }
            })
            .catch(error => {
                profileOutput.textContent = 'BŁĄD POŁĄCZENIA: ' + error.message;
                historyOutput.textContent = '';
                console.error('Błąd pobierania profilu:', error);
            });
        }
    </script>
</body>
</html>
